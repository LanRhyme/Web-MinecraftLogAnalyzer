<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft日志分析器</title>
    <script src="https://cdn.tailwindcss.com/3.3.3"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: rgba(243, 244, 246, 0.8);
            color: #1f2937;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            transition: all 0.3s ease;
        }
        .amethyst-dark {
            background-color: #357e3b;
        }
        .chart-container {
            height: 300px;
            width: 100%;
            position: relative;
        }
        .highlight-text {
            position: relative;
            display: inline-block;
        }
        .highlight-text::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background-color: rgba(131, 204, 102, 0.3);
            z-index: -1;
        }
        .blob {
            position: absolute;
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, rgba(143, 204, 102, 0.2) 0%, rgba(120, 154, 75, 0.2) 100%);
            filter: blur(60px);
            border-radius: 50%;
            z-index: -1;
            animation: blob-movement 15s infinite linear;
        }
        #analysisResult .result-card {
            padding: 1.5rem !important;
            border-radius: 15px !important;
            margin-bottom: 1.5rem !important;
            color: #374151 !important;
            position: relative !important;
            z-index: 1 !important;
            background: rgba(255, 255, 255, 0.65) !important;
            backdrop-filter: blur(12px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .anim-card {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .anim-card.active {
            opacity: 1;
            transform: translateY(0);
        }
        .mc-bg-blur {
            position: fixed;
            z-index: -1;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            background: url('img/mc1.jpg') center center no-repeat;
            background-size: cover;
            filter: blur(16px) brightness(0.7);
        }
        @keyframes blob-movement {
            0% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(5%, -10%) scale(1.3); }
            66% { transform: translate(-15%, 5%) scale(0.9); }
            100% { transform: translate(0, 0) scale(1); }
        }
        #custom-menu {
            display: none;
            position: fixed;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 0.5rem 0;
            z-index: 9999;
            min-width: 180px;
            overflow: hidden;
            transition: all 0.2s ease-out;
            transform-origin: top left;
            opacity: 0;
            transform: scale(0.95);
            border: 1px solid rgba(0, 0, 0, 0.1);
            user-select: none;
        }
        #custom-menu.visible { opacity: 1; transform: scale(1); }
        #custom-menu.hiding { opacity: 0; transform: scale(0.95); }
        .menu-item { display: flex; align-items: center; padding: 0.75rem 1.25rem; cursor: pointer; transition: all 0.2s ease; color: #374151; }
        .menu-item:hover { background-color: #f3f4f6; border-radius: 15px; }
        .menu-item i { width: 1.5rem; margin-right: 0.75rem; color: #6b7280; }
        .menu-divider { border-top: 1px solid #e5e7eb; margin: 0.25rem 0; }
        .menu-header { padding: 0.5rem 1.25rem; font-size: 0.875rem; color: #9ca3af; text-transform: uppercase; font-weight: 500; }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden">
    <div class="mc-bg-blur"></div>
    <div class="blob top-0 left-0"></div>
    <div class="blob bottom-0 right-0"></div>

    <nav class="glassmorphism sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center">
                <div class="w-10 h-10 amethyst-bg flex items-center justify-center text-white mr-3 rounded-lg">
                    <i class="fas fa-file-alt text-green-600"></i>
                </div>
                <h1 class="text-xl font-bold text-gray-800">Minecraft-ios日志分析器</h1>
            </div>
            <a href="https://lanrhyme.great-site.net" class="amethyst-dark text-white px-6 py-3 rounded-lg font-medium hover:bg-green-800 transition-colors">
                <i class="fas fa-arrow-left mr-2 text-green-600"></i>返回LanRhyme的个人网站
            </a>
        </div>
    </nav>

    <header class="amethyst-bg text-white py-16 relative overflow-hidden">
        <div class="container mx-auto px-4 text-center relative z-10">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Minecraft日志分析器</h1>
            <p class="text-xl md:text-2xl mb-8">Amethyst(Pojav)-IOS专用，其他启动器可能也可以？</p>
            <div class="max-w-3xl mx-auto glassmorphism p-6">
                <div class="flex flex-col md:flex-row gap-4">
                    <input id="logFile" type="file" class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" accept=".log,.txt">
                    <button id="uploadBtn" class="amethyst-dark text-white px-6 py-3 rounded-lg font-medium hover:bg-green-800 transition-colors">
                        <i class="fas fa-upload mr-2 text-green-600"></i>上传日志文件
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-2">支持.log和.txt格式的Minecraft日志文件，请确保文件大小小于8M，若依旧无法解决请把此界面截图和日志文件发送给他人</p>
            </div>
            <div id="analysisResult" class="mt-6"></div>
        </div>
    </header>

    <section id="analysis" class="container mx-auto py-12 px-4">
        <div class="glassmorphism p-6 mb-8 anim-card">
            <h3 class="text-2xl font-semibold mb-4 flex items-center">
                <span class="w-10 h-10 amethyst-bg rounded-full flex items-center justify-center text-white mr-3">
                    <i class="fas fa-exclamation-triangle text-green-600"></i>
                </span>
                错误统计*没写
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <div class="mb-4">
                        <h4 class="font-medium text-gray-700 mb-2">错误类型分布</h4>
                        <div class="chart-container">
                            <canvas id="errorChart"></canvas>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-700 mb-3">常见错误</h4>
                        <div class="space-y-3">
                            <div class="bg-red-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="font-medium text-red-700">sodium!!!</span><span class="text-sm bg-red-100 text-red-800 px-2 py-1 rounded">32次</span></div><p class="text-sm text-gray-600 mt-1">别jb用优化模组了</p></div>
                            <div class="bg-yellow-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="font-medium text-yellow-700">网络问题</span><span class="text-sm bg-yellow-100 text-yellow-800 px-2 py-1 rounded">18次</span></div><p class="text-sm text-gray-600 mt-1">梯子是个好东西</p></div>
                            <div class="bg-blue-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="font-medium text-blue-700">渲染器崩溃</span><span class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">12次</span></div><p class="text-sm text-gray-600 mt-1">自动！自动！自动！</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="visualization" class="container mx-auto py-12 px-4">
        <div class="glassmorphism p-6 anim-card">
            <h3 class="text-2xl font-semibold mb-4 flex items-center">
                <span class="w-10 h-10 amethyst-bg rounded-full flex items-center justify-center text-white mr-3">
                    <i class="fas fa-chart-line text-green-600"></i>
                </span>
                玩家每日上传日志数量
            </h3>
            <div class="chart-container">
                <canvas id="uploadChart"></canvas>
            </div>
        </div>
    </section>

    <footer class="bg-white text-gray-700 py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0"><div class="flex items-center"><div class="w-8 h-8 amethyst-bg flex items-center justify-center text-white mr-2 rounded"><i class="fas fa-file-alt text-green-600"></i></div><span class="font-bold">LanRhyme的日志分析器</span></div><p class="text-sm text-gray-500 mt-2">by LanRhyme</p></div>
                <div class="text-sm text-gray-500"><p>from <a href="https://lanrhyme.great-site.net" class="text-green-600 hover:text-green-800">https://lanrhyme.great-site.net</a></p><p>©2025</p></div>
            </div>
        </div>
    </footer>

    <div id="custom-menu">
        <div class="menu-header">常规操作</div>
        <div class="menu-item" id="back-item" onclick="backAction()"><i class="fa fa-arrow-left"></i><span>返回</span></div>
        <div class="menu-item" id="refresh-item" onclick="refreshAction()"><i class="fa fa-refresh"></i><span>刷新</span></div>
        <div class="menu-divider"></div>
        <div class="menu-header">编辑操作</div>
        <div class="menu-item" id="copy-item" onclick="copyAction()"><i class="fa fa-copy"></i><span>复制</span></div>
        <div class="menu-item" id="paste-item" onclick="pasteAction()"><i class="fa fa-paste"></i><span>粘贴</span></div>
        <div class="menu-divider"></div>
        <div class="menu-header">链接操作</div>
        <div class="menu-item" id="open-in-new-tab-item" onclick="openInNewTabAction()"><i class="fa fa-external-link"></i><span>在新标签页打开</span></div>
        <div class="menu-item" id="copy-link-item" onclick="copyLinkAction()"><i class="fa fa-link"></i><span>复制链接地址</span></div>
        <div class="menu-divider"></div>
        <div class="menu-header">其他操作</div>
        <div class="menu-item" id="back-to-home-item" onclick="backToHomeAction()"><i class="fa fa-home"></i><span>返回主页</span></div>
    </div>

    <script>
        // Custom Right-Click Menu JavaScript
        const customMenu = document.getElementById('custom-menu');
        const backItem = document.getElementById('back-item');
        const refreshItem = document.getElementById('refresh-item');
        const copyItem = document.getElementById('copy-item');
        const pasteItem = document.getElementById('paste-item');
        const openInNewTabItem = document.getElementById('open-in-new-tab-item');
        const copyLinkItem = document.getElementById('copy-link-item');
        const backToHomeItem = document.getElementById('back-to-home-item');
        let isMenuVisible = false, currentTarget = null, selectedText = '', isAnimating = false, menuOpenTime = 0, focusedElementBeforeMenu = null, scrollTimer = null, touchStartY = 0;
        document.addEventListener('wheel', handleScroll, { passive: true });
        document.addEventListener('touchstart', (e) => { if (isMenuVisible) { touchStartY = e.touches[0].clientY; } }, { passive: true });
        document.addEventListener('touchmove', (e) => { if (isMenuVisible) { const touchY = e.touches[0].clientY; const diff = Math.abs(touchY - touchStartY); if (diff > 5) { hideMenu(); } } }, { passive: true });
        window.addEventListener('scroll', handleScroll, { passive: true });
        function handleScroll() { if (isMenuVisible) { if (scrollTimer) { clearTimeout(scrollTimer); } scrollTimer = setTimeout(() => { hideMenu(); }, 50); } }
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            focusedElementBeforeMenu = document.activeElement;
            const now = Date.now();
            const isNewOpen = !isMenuVisible || (now - menuOpenTime > 300);
            selectedText = window.getSelection().toString();
            currentTarget = e.target.closest('a');
            updateMenuItemsVisibility();
            customMenu.style.display = 'block';
            const menuRect = customMenu.getBoundingClientRect();
            customMenu.style.display = 'none';
            const menuWidth = menuRect.width;
            const menuHeight = menuRect.height;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const clickX = e.clientX;
            const clickY = e.clientY;
            let left = clickX;
            if (clickX + menuWidth > viewportWidth) { left = Math.max(0, viewportWidth - menuWidth); }
            let top = clickY;
            if (clickY + menuHeight > viewportHeight) { top = Math.max(0, clickY - menuHeight); }
            if (isNewOpen) { showMenu(left, top); } else { moveMenu(left, top); }
            menuOpenTime = now;
        });
        function showMenu(left, top) { if (isAnimating) return; isAnimating = true; customMenu.style.position = 'fixed'; customMenu.style.left = `${left}px`; customMenu.style.top = `${top}px`; customMenu.style.display = 'block'; customMenu.classList.remove('hiding'); requestAnimationFrame(() => { customMenu.classList.add('visible'); setTimeout(() => { isAnimating = false; isMenuVisible = true; }, 150); }); }
        function moveMenu(left, top) { if (isAnimating) return; isAnimating = true; customMenu.style.position = 'fixed'; customMenu.style.left = `${left}px`; customMenu.style.top = `${top}px`; setTimeout(() => { isAnimating = false; }, 150); }
        document.addEventListener('click', function (e) { if (!customMenu.contains(e.target) && isMenuVisible) { hideMenu(); } });
        document.addEventListener('keydown', function (e) { if (e.key === 'Escape' && isMenuVisible) { hideMenu(); } });
        function updateMenuItemsVisibility() { backItem.style.display = 'flex'; refreshItem.style.display = 'flex'; copyItem.style.display = 'flex'; pasteItem.style.display = 'flex'; openInNewTabItem.style.display = 'flex'; copyLinkItem.style.display = 'flex'; backToHomeItem.style.display = 'flex'; if (currentTarget) { backItem.style.display = 'none'; refreshItem.style.display = 'none'; pasteItem.style.display = 'none'; } else { openInNewTabItem.style.display = 'none'; copyLinkItem.style.display = 'none'; } if (!selectedText) { copyItem.style.display = 'none'; } }
        function hideMenu() { if (isAnimating) return; isAnimating = true; customMenu.classList.remove('visible'); customMenu.classList.add('hiding'); setTimeout(() => { customMenu.style.display = 'none'; customMenu.classList.remove('hiding'); isAnimating = false; isMenuVisible = false; }, 150); }
        function backAction() { window.history.back(); hideMenu(); }
        function refreshAction() { location.reload(); hideMenu(); }
        function copyAction() { if (selectedText) { if (navigator.clipboard) { navigator.clipboard.writeText(selectedText).catch((err) => { fallbackCopyText(selectedText); }); } else { fallbackCopyText(selectedText); } } hideMenu(); }
        function fallbackCopyText(text) { const textarea = document.createElement('textarea'); textarea.value = text; textarea.style.position = 'fixed'; textarea.style.opacity = '0'; document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); }
        function pasteAction() { const targetElement = focusedElementBeforeMenu; if (targetElement && (targetElement.tagName === 'INPUT' || targetElement.tagName === 'TEXTAREA' || targetElement.isContentEditable)) { if (navigator.clipboard) { navigator.clipboard.readText().then((clipboardText) => { if (typeof targetElement.execCommand === 'function') { document.execCommand('insertText', false, clipboardText); } }).catch((err) => {}); } } hideMenu(); }
        function openInNewTabAction() { if (currentTarget) { window.open(currentTarget.href, '_blank'); } hideMenu(); }
        function copyLinkAction() { if (currentTarget) { if (navigator.clipboard) { navigator.clipboard.writeText(currentTarget.href).catch((err) => { fallbackCopyText(currentTarget.href); }); } else { fallbackCopyText(currentTarget.href); } } hideMenu(); }
        function backToHomeAction() { window.location.href = '/'; hideMenu(); }

        // Original Page JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            const errorCtx = document.getElementById('errorChart').getContext('2d');
            new Chart(errorCtx, { type: 'doughnut', data: { labels: ['网络问题', '模组问题', '渲染器问题', '启动器本身', '其他'], datasets: [{ data: [32, 18, 12, 8, 5], backgroundColor: ['rgba(239, 68, 68, 0.7)', 'rgba(234, 179, 8, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(75, 85, 99, 0.7)'], borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', } } } });
            const uploadCtx = document.getElementById('uploadChart').getContext('2d');
            new Chart(uploadCtx, { type: 'bar', data: { labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'], datasets: [{ label: '上传日志数量', data: [15, 18, 22, 20, 25, 30, 28], backgroundColor: 'rgba(10, 100, 10, 0.7)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } }, x: { grid: { display: false } } } } });
        });

        document.addEventListener("DOMContentLoaded", function() {
            const cards = document.querySelectorAll(".anim-card");
            function checkVisibility() { cards.forEach(card => { const rect = card.getBoundingClientRect(); const isVisible = rect.top < (window.innerHeight || document.documentElement.clientHeight) && rect.bottom >= 0; if (isVisible && !card.classList.contains('active')) { card.classList.add('active'); } }); }
            checkVisibility();
            window.addEventListener("scroll", checkVisibility);
        });

        // --- MODIFIED: Log Upload & Analysis with REAL API calls ---
        document.getElementById('uploadBtn').onclick = async function () {
            const fileInput = document.getElementById('logFile');
            const file = fileInput.files[0];
            if (!file) {
                alert('请选择日志文件');
                return;
            }
            const formData = new FormData();
            formData.append('file', file);
            const resultDiv = document.getElementById('analysisResult');
            resultDiv.innerHTML = '<div class="text-gray-200">分析中，请稍候...</div>';

            try {
                // 1. Fetch extracted info from the server
                const res1 = await fetch('/api/extract', { method: 'POST', body: formData });
                const data1 = await res1.json();
                if (data1.error) {
                    resultDiv.innerHTML = `<div class="text-red-400">${data1.error}</div>`;
                    return;
                }

                // 2. Display basic info card with proper labels
                const infoDisplayMap = {
                    launcher_version: '启动器版本',
                    java_version: 'Java 版本',
                    renderer: '渲染器',
                    minecraft_version: '游戏版本',
                    keyword: '关键词'
                };
                let infoHtml = `<div class="result-card anim-card">
                    <div class="text-lg font-bold text-gray-800">基础信息提取</div>
                    <hr class="my-3 border-gray-600/10">
                    <ul class="list-disc list-inside text-left">`;
                for (const key in data1.info) {
                    if (Object.prototype.hasOwnProperty.call(data1.info, key)) {
                        const displayName = infoDisplayMap[key] || key;
                        infoHtml += `<li><b>${displayName}：</b>${data1.info[key]}</li>`;
                    }
                }
                infoHtml += '</ul></div>';
                resultDiv.innerHTML = infoHtml;
                
                setTimeout(() => { document.querySelector('#analysisResult .anim-card').classList.add('active'); }, 50);

                // 3. Display Gemini analysis card placeholder
                resultDiv.innerHTML += `<div id="geminiCard" class="result-card anim-card">
                    <div class="text-lg font-bold text-gray-800">AI 分析结果</div>
                    <hr class="my-3 border-gray-600/10">
                    <div class="gemini-content text-left text-gray-700" style="white-space: pre-wrap; word-wrap: break-word;">分析中，请稍候...</div>
                </div>`;
                
                setTimeout(() => { document.querySelector('#geminiCard').classList.add('active'); }, 250);
                
                // 4. Fetch AI analysis from the server
                fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ log: data1.log }) // Rely on server's .env for proxy/API key
                })
                .then(res2 => res2.json())
                .then(data2 => {
                    const aiDiv = document.querySelector('#geminiCard .gemini-content');
                    aiDiv.innerText = data2.gemini; // innerText handles newlines correctly

                    // 5. Add copy button
                    let copyBtn = document.createElement('button');
                    copyBtn.innerText = '复制分析内容';
                    copyBtn.className = 'mt-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors copy-btn';
                    copyBtn.onclick = function() {
                        const baseCardList = resultDiv.querySelectorAll('.result-card:not(#geminiCard) ul li');
                        const baseCardText = Array.from(baseCardList).map(li => li.innerText).join('\n');
                        const aiCardText = resultDiv.querySelector('#geminiCard .gemini-content').innerText;
                        const text = `【基础信息】\n${baseCardText}\n\n【AI分析】\n${aiCardText}`;
                        navigator.clipboard.writeText(text).then(() => {
                            copyBtn.innerText = '已复制！';
                            setTimeout(() => { copyBtn.innerText = '复制分析内容'; }, 1500);
                        });
                    };
                    document.querySelector('#geminiCard').appendChild(copyBtn);
                })
                .catch(e => {
                    document.querySelector('#geminiCard .gemini-content').innerText = 'AI分析失败：' + e.message;
                });
                
            } catch (e) {
                resultDiv.innerHTML = `<div class="text-red-400">分析失败：${e.message}</div>`;
            }
        };
    </script>
</body>
</html>